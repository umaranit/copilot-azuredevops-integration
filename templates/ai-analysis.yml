# âš¡ Reusable Template: AI Analysis with Copilot
# Perform AI analysis on work items with configurable analysis modes

parameters:
  - name: analysisMode
    type: string
    default: 'standard'
    values:
      - 'basic'      # Quick quality check
      - 'standard'   # INVEST analysis
      - 'detailed'   # Comprehensive analysis
      - 'governance' # Compliance focus
  - name: analysisType
    type: string
    default: 'backlog'
    values:
      - 'backlog'    # Backlog quality analysis
      - 'sprint'     # Sprint readiness analysis
      - 'release'    # Release readiness analysis
      - 'custom'     # Custom analysis
  - name: nodeVersion
    type: string
    default: '22'
  - name: maxRetries
    type: number
    default: 3

steps:
- script: |
    echo "ðŸ› ï¸ Setting up GitHub Copilot CLI for Analysis"
    echo "Node.js Version: ${{ parameters.nodeVersion }}"
    echo "Max Retries: ${{ parameters.maxRetries }}"
    
    # Install Node.js with retry
    retry_command() {
      local cmd="$1"
      local max_attempts="${{ parameters.maxRetries }}"
      local attempt=1
      
      while [ $attempt -le $max_attempts ]; do
        echo "Attempt $attempt/$max_attempts: $cmd"
        if eval "$cmd"; then
          echo "âœ… Command succeeded"
          return 0
        else
          echo "âŒ Command failed"
          if [ $attempt -eq $max_attempts ]; then
            return 1
          fi
          sleep 5
          attempt=$((attempt + 1))
        fi
      done
    }
    
    # Install prerequisites
    retry_command "curl -fsSL https://deb.nodesource.com/setup_${{ parameters.nodeVersion }}.x | sudo -E bash -"
    retry_command "sudo apt-get update && sudo apt-get install -y nodejs jq curl"
    
    # Install Copilot CLI
    retry_command "sudo npm install -g @github/copilot@latest --timeout=60000"
    
    # Verify installation
    which copilot || { echo "âŒ Copilot CLI not found"; exit 1; }
    
    echo "âœ… GitHub Copilot CLI ready for analysis"
    
  displayName: 'Setup Copilot CLI for Analysis'

- script: |
    echo "ðŸ” Testing Copilot Authentication"
    export GITHUB_TOKEN="$(GITHUB_TOKEN)"
    export GH_TOKEN="$(GITHUB_TOKEN)"
    
    # Simple authentication test
    if echo "What is 2+2? Answer with just the number." | timeout 15 copilot > /dev/null 2>&1; then
      echo "âœ… Copilot authentication successful"
    else
      echo "âŒ Copilot authentication failed"
      echo "Please check your GITHUB_TOKEN and Copilot subscription"
      exit 1
    fi
    
  displayName: 'Test Copilot Authentication'
  env:
    GITHUB_TOKEN: $(GITHUB_TOKEN)

- script: |
    echo "ðŸ¤– AI Analysis with Copilot (Template v1.2)"
    echo "Analysis Mode: ${{ parameters.analysisMode }}"
    echo "Analysis Type: ${{ parameters.analysisType }}"
    
    # Setup environment variables
    export GITHUB_TOKEN="$(GITHUB_TOKEN)"
    export GH_TOKEN="$(GITHUB_TOKEN)"
    
    # Verify token is set
    if [ -z "$GITHUB_TOKEN" ]; then
      echo "âŒ ERROR: GITHUB_TOKEN is not set!"
      exit 1
    fi
    
    echo "âœ… GITHUB_TOKEN is set"
    
    # Test Copilot is working first
    echo "Testing Copilot..."
    TEST_RESULT=$(echo "Say 'working'" | timeout 10 copilot 2>&1)
    TEST_EXIT=$?
    
    if [ $TEST_EXIT -ne 0 ]; then
      echo "âŒ ERROR: Copilot test failed (exit code: $TEST_EXIT)"
      echo "Response: $TEST_RESULT"
      exit 1
    fi
    
    echo "âœ… Copilot test passed"
    
    # Initialize report
    REPORT_FILE="$(Agent.TempDirectory)/analysis-report.md"
    echo "# ðŸ¤– AI Analysis Report" > "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "**Analysis Type:** ${{ parameters.analysisType }}" >> "$REPORT_FILE"
    echo "**Analysis Mode:** ${{ parameters.analysisMode }}" >> "$REPORT_FILE"
    echo "**Generated:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "---" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    
    # Process work items
    WORKITEMS_FILE="$(Agent.TempDirectory)/workitems-data/workitems_detailed.json"
    
    if [ -f "$WORKITEMS_FILE" ]; then
      TOTAL_ITEMS=$(cat "$WORKITEMS_FILE" | jq '.value | length')
      echo "ðŸ“Š Processing $TOTAL_ITEMS work items..."
      
      PROCESSED=0
      FAILED=0
      
      # Process each work item with simple approach
      for i in $(seq 0 $((TOTAL_ITEMS - 1))); do
        # Get work item at index i
        ITEM=$(cat "$WORKITEMS_FILE" | jq -c ".value[$i]")
        
        if [ "$ITEM" = "null" ] || [ -z "$ITEM" ]; then
          echo "No more items to process"
          break
        fi
        
        # Extract fields safely
        ID=$(echo "$ITEM" | jq -r '.id')
        TITLE=$(echo "$ITEM" | jq -r '.fields."System.Title" // "No Title"' | sed 's/["`]//g' | head -c 100)
        TYPE=$(echo "$ITEM" | jq -r '.fields."System.WorkItemType" // "Unknown"')
        DESCRIPTION=$(echo "$ITEM" | jq -r '.fields."System.Description" // ""' | sed 's/<[^>]*>//g' | head -c 200 | sed 's/["`]//g')
        
        echo "ðŸ” Analyzing Work Item $ID: $TITLE"
        
        # Create simple prompt based on analysis mode
        case "${{ parameters.analysisMode }}" in
          "basic")
            PROMPT="Analyze this work item for quality (1-10 score) and list 2 key issues: Title: $TITLE. Description: $DESCRIPTION."
            ;;
          "detailed")
            PROMPT="Comprehensive analysis of this work item. Provide: 1) Quality score (1-10), 2) INVEST principle breakdown, 3) Detailed issues list, 4) Specific recommendations: Title: $TITLE. Description: $DESCRIPTION."
            ;;
          *)
            PROMPT="Analyze this work item using INVEST principles. Provide: 1) Overall score (1-10), 2) INVEST compliance, 3) Top 3 issues, 4) One key recommendation: Title: $TITLE. Description: $DESCRIPTION."
            ;;
        esac
        
        # Call Copilot with proper error handling
        echo "ðŸ“ Sending analysis request to Copilot..."
        ANALYSIS=$(echo "$PROMPT" | timeout 60 copilot 2>&1)
        COPILOT_EXIT=$?
        
        if [ $COPILOT_EXIT -eq 124 ]; then
          echo "âŒ Analysis timeout for Work Item $ID"
          FAILED=$((FAILED + 1))
        elif [ $COPILOT_EXIT -ne 0 ]; then
          echo "âŒ Analysis failed for Work Item $ID (exit: $COPILOT_EXIT)"
          echo "Response: $ANALYSIS"
          FAILED=$((FAILED + 1))
        else
          echo "âœ… Analysis completed for Work Item $ID"
          PROCESSED=$((PROCESSED + 1))
          
          # Add to report
          echo "## ðŸ“‹ Work Item #$ID: $TITLE" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "**Type:** $TYPE" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "$ANALYSIS" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "---" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
        fi
        
        # Add failed items to report for visibility
        if [ $COPILOT_EXIT -ne 0 ]; then
          echo "## âŒ Work Item #$ID: $TITLE (Analysis Failed)" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "**Type:** $TYPE" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "**Status:** Analysis failed - timeout or error" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "---" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
        fi
        
        # Rate limiting
        sleep 2
      done
      
      echo "ðŸŽ‰ Analysis complete: $PROCESSED/$TOTAL_ITEMS items processed"
      
      # Add summary
      echo "## ðŸ“Š Analysis Summary" >> "$REPORT_FILE"
      echo "" >> "$REPORT_FILE"
      echo "- **Total Items:** $TOTAL_ITEMS" >> "$REPORT_FILE"
      echo "- **Successfully Analyzed:** $PROCESSED" >> "$REPORT_FILE"
      echo "- **Failed:** $FAILED" >> "$REPORT_FILE"
      echo "" >> "$REPORT_FILE"
    else
      echo "âŒ No work items data file found"
      echo "ðŸ“„ Creating minimal analysis report..."
      
      echo "## ðŸ” Analysis Results" >> "$REPORT_FILE"
      echo "" >> "$REPORT_FILE"
      echo "**No work items data file was found.**" >> "$REPORT_FILE"
      echo "" >> "$REPORT_FILE"
      echo "This indicates an issue with the previous fetch stage." >> "$REPORT_FILE"
      echo "" >> "$REPORT_FILE"
    fi
  displayName: 'AI Analysis with Copilot'
  env:
    GITHUB_TOKEN: $(GITHUB_TOKEN)

- task: PublishBuildArtifacts@1
  displayName: 'Publish Analysis Report'
  inputs:
    pathToPublish: '$(Agent.TempDirectory)/analysis-report.md'
    artifactName: 'analysis-report'
