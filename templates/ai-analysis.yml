# ‚ö° Reusable Template: AI Analysis with Copilot
# Perform AI analysis on work items with configurable analysis modes

parameters:
  - name: analysisMode
    type: string
    default: 'standard'
    values:
      - 'basic'      # Quick quality check
      - 'standard'   # INVEST analysis
      - 'detailed'   # Comprehensive analysis
      - 'governance' # Compliance focus
  - name: analysisType
    type: string
    default: 'backlog'
    values:
      - 'backlog'    # Backlog quality analysis
      - 'sprint'     # Sprint readiness analysis
      - 'release'    # Release readiness analysis
      - 'custom'     # Custom analysis
  - name: nodeVersion
    type: string
    default: '22'
  - name: maxRetries
    type: number
    default: 3

steps:
- script: |
    echo "üõ†Ô∏è Setting up GitHub Copilot CLI for Analysis"
    echo "Node.js Version: ${{ parameters.nodeVersion }}"
    echo "Max Retries: ${{ parameters.maxRetries }}"
    
    # Install Node.js with retry
    retry_command() {
      local cmd="$1"
      local max_attempts="${{ parameters.maxRetries }}"
      local attempt=1
      
      while [ $attempt -le $max_attempts ]; do
        echo "Attempt $attempt/$max_attempts: $cmd"
        if eval "$cmd"; then
          echo "‚úÖ Command succeeded"
          return 0
        else
          echo "‚ùå Command failed"
          if [ $attempt -eq $max_attempts ]; then
            return 1
          fi
          sleep 5
          attempt=$((attempt + 1))
        fi
      done
    }
    
    # Install prerequisites
    retry_command "curl -fsSL https://deb.nodesource.com/setup_${{ parameters.nodeVersion }}.x | sudo -E bash -"
    retry_command "sudo apt-get update && sudo apt-get install -y nodejs jq curl"
    
    # Install Copilot CLI
    retry_command "sudo npm install -g @github/copilot@latest --timeout=60000"
    
    # Verify installation
    which copilot || { echo "‚ùå Copilot CLI not found"; exit 1; }
    
    echo "‚úÖ GitHub Copilot CLI ready for analysis"
    
  displayName: 'Setup Copilot CLI for Analysis'

- script: |
    echo "üîê Testing Copilot Authentication"
    export GITHUB_TOKEN="$(GITHUB_TOKEN)"
    export GH_TOKEN="$(GITHUB_TOKEN)"
    
    # Simple authentication test
    if echo "What is 2+2? Answer with just the number." | timeout 15 copilot > /dev/null 2>&1; then
      echo "‚úÖ Copilot authentication successful"
    else
      echo "‚ùå Copilot authentication failed"
      echo "Please check your GITHUB_TOKEN and Copilot subscription"
      exit 1
    fi
    
  displayName: 'Test Copilot Authentication'
  env:
    GITHUB_TOKEN: $(GITHUB_TOKEN)

- script: |
    echo "ü§ñ AI Analysis with Copilot (Template v1.1)"
    echo "Analysis Mode: ${{ parameters.analysisMode }}"
    echo "Analysis Type: ${{ parameters.analysisType }}"
    
    # Setup environment variables
    export GITHUB_TOKEN="$(GITHUB_TOKEN)"
    export GH_TOKEN="$(GITHUB_TOKEN)"
    
    # Define analysis prompts based on mode and type
    get_analysis_prompt() {
      local mode="$1"
      local type="$2"
      
      case "${type}_${mode}" in
        "backlog_basic")
          echo "Briefly analyze this work item for quality (1-10 score) and list 2 key issues:"
          ;;
        "backlog_standard")
          echo "Analyze this work item using INVEST principles. Provide: 1) Overall score (1-10), 2) INVEST compliance, 3) Top 3 issues, 4) One key recommendation:"
          ;;
        "sprint_standard")
          echo "Analyze this work item for sprint readiness. Provide: 1) Readiness score (1-10), 2) Definition of Done compliance, 3) Blockers/dependencies, 4) Sprint planning recommendations:"
          ;;
        "release_standard")
          echo "Analyze this work item for release readiness. Provide: 1) Release readiness score (1-10), 2) Quality gates status, 3) Risk assessment, 4) Go/No-go recommendation:"
          ;;
        "backlog_detailed")
          echo "Comprehensive backlog analysis of this work item. Provide: 1) Quality score (1-10), 2) INVEST principle breakdown, 3) Detailed issues list, 4) Specific recommendations, 5) Risk assessment:"
          ;;
        *)
          echo "Analyze this work item and provide improvement recommendations:"
          ;;
      esac
    }
    
    ANALYSIS_PROMPT=$(get_analysis_prompt "${{ parameters.analysisMode }}" "${{ parameters.analysisType }}")
    echo "üìù Using prompt: $ANALYSIS_PROMPT"
    
    # Initialize report
    REPORT_FILE="$(Agent.TempDirectory)/analysis-report.md"
    echo "# ü§ñ AI Analysis Report" > "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "**Analysis Type:** ${{ parameters.analysisType }}" >> "$REPORT_FILE"
    echo "**Analysis Mode:** ${{ parameters.analysisMode }}" >> "$REPORT_FILE"
    echo "**Generated:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "---" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    
    # Process work items
    WORKITEMS_FILE="$(Agent.TempDirectory)/workitems-data/workitems_detailed.json"
    
    if [ -f "$WORKITEMS_FILE" ]; then
      TOTAL_ITEMS=$(cat "$WORKITEMS_FILE" | jq '.value | length')
      echo "üìä Processing $TOTAL_ITEMS work items..."
      
      PROCESSED=0
      FAILED=0
      
      # Check if we have any work items to process
      if [ "$TOTAL_ITEMS" -gt 0 ]; then
        # Process each work item
        for i in $(seq 0 $((TOTAL_ITEMS - 1))); do
          ITEM=$(cat "$WORKITEMS_FILE" | jq ".value[$i]")
          ID=$(echo "$ITEM" | jq -r '.id')
          TITLE=$(echo "$ITEM" | jq -r '.fields."System.Title" // "No Title"')
          TYPE=$(echo "$ITEM" | jq -r '.fields."System.WorkItemType" // "Unknown"')
          DESCRIPTION=$(echo "$ITEM" | jq -r '.fields."System.Description" // ""')
          
          # Perform Copilot analysis with timeout
          echo "üîç Analyzing Work Item $ID: $TITLE"
          
          # Create analysis input
          ANALYSIS_INPUT="Work Item ID: $ID
    Title: $TITLE
    Type: $TYPE
    Description: $DESCRIPTION
    
    $ANALYSIS_PROMPT"
          
          # Perform Copilot analysis with timeout and better error handling
          echo "üìù Sending analysis request to Copilot..."
          if echo "$ANALYSIS_INPUT" | timeout 60 copilot > "analysis_$ID.md" 2>"analysis_error_$ID.log"; then
            echo "‚úÖ Analysis completed for Work Item $ID"
            
            # Add to report
            echo "## üìã Work Item #$ID: $TITLE" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "**Type:** $TYPE" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            cat "analysis_$ID.md" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "---" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            
            PROCESSED=$((PROCESSED + 1))
          else
            echo "‚ùå Analysis failed for Work Item $ID"
            echo "Error details:"
            if [ -f "analysis_error_$ID.log" ]; then
              cat "analysis_error_$ID.log"
            else
              echo "No error log available"
            fi
            
            # Add failed item to report for visibility
            echo "## ‚ùå Work Item #$ID: $TITLE (Analysis Failed)" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "**Type:** $TYPE" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "**Status:** Analysis failed - please check logs" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "---" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            
            FAILED=$((FAILED + 1))
          fi
          
          # Rate limiting
          sleep 2
        done
        
        echo "üéâ Analysis complete: $PROCESSED/$TOTAL_ITEMS items processed"
      else
        echo "‚ö†Ô∏è No work items found for analysis"
        echo "üìÑ Creating empty analysis report..."
        
        # Add a message for empty results
        echo "## üîç Analysis Results" >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
        echo "**No work items found matching the specified criteria.**" >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
        echo "This could be due to:" >> "$REPORT_FILE"
        echo "- No work items of the specified types exist in the project" >> "$REPORT_FILE"
        echo "- The query filters are too restrictive" >> "$REPORT_FILE"
        echo "- The work item types don't match the project template" >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
        echo "Consider adjusting the work item types or query parameters." >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
      fi
      
      # Add summary
      echo "## üìä Analysis Summary" >> "$REPORT_FILE"
      echo "" >> "$REPORT_FILE"
      echo "- **Total Items:** $TOTAL_ITEMS" >> "$REPORT_FILE"
      echo "- **Successfully Analyzed:** $PROCESSED" >> "$REPORT_FILE"
      echo "- **Failed:** $FAILED" >> "$REPORT_FILE"
      echo "" >> "$REPORT_FILE"
    else
      echo "‚ùå No work items data file found"
      echo "üìÑ Creating minimal analysis report..."
      
      # Create a basic report even when no data file exists
      echo "## üîç Analysis Results" >> "$REPORT_FILE"
      echo "" >> "$REPORT_FILE"
      echo "**No work items data file was found.**" >> "$REPORT_FILE"
      echo "" >> "$REPORT_FILE"
      echo "This indicates an issue with the previous fetch stage." >> "$REPORT_FILE"
      echo "Please check the fetch work items stage for errors." >> "$REPORT_FILE"
      echo "" >> "$REPORT_FILE"
      echo "## üìä Analysis Summary" >> "$REPORT_FILE"
      echo "" >> "$REPORT_FILE"
      echo "- **Total Items:** 0" >> "$REPORT_FILE"
      echo "- **Successfully Analyzed:** 0" >> "$REPORT_FILE"
      echo "- **Failed:** 0" >> "$REPORT_FILE"
      echo "" >> "$REPORT_FILE"
      
      echo "‚ö†Ô∏è Continuing with empty report instead of failing"
    fi
  displayName: 'AI Analysis with Copilot'
  env:
    GITHUB_TOKEN: $(GITHUB_TOKEN)

- task: PublishBuildArtifacts@1
  displayName: 'Publish Analysis Report'
  inputs:
    pathToPublish: '$(Agent.TempDirectory)/analysis-report.md'
    artifactName: 'analysis-report'
