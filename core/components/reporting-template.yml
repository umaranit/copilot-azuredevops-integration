# Azure Pipeline Template: Generate Analysis Reports
# Reusable component for creating comprehensive reports from AI analysis

parameters:
  - name: reportTitle
    displayName: 'Report Title'
    type: string
    default: 'Backlog Analysis Report'
  
  - name: includeCharts
    displayName: 'Include Visual Charts'
    type: boolean
    default: true
  
  - name: generatePDF
    displayName: 'Generate PDF Report'
    type: boolean
    default: false
  
  - name: notificationEnabled
    displayName: 'Enable Notifications'
    type: boolean
    default: true
  
  - name: sharePointUpload
    displayName: 'Upload to SharePoint'
    type: boolean
    default: false
  
  - name: emailRecipients
    displayName: 'Email Recipients (comma-separated)'
    type: string
    default: ''
  
  - name: reportFormats
    displayName: 'Report Formats'
    type: object
    default:
      - 'html'
      - 'markdown'

stages:
- stage: GenerateReports
  displayName: 'Generate Analysis Reports'
  jobs:
  - job: CreateReports
    displayName: 'Create Comprehensive Reports'
    variables:
      REPORT_TITLE: ${{ parameters.reportTitle }}
      INCLUDE_CHARTS: ${{ parameters.includeCharts }}
      GENERATE_PDF: ${{ parameters.generatePDF }}
      NOTIFICATION_ENABLED: ${{ parameters.notificationEnabled }}
      SHAREPOINT_UPLOAD: ${{ parameters.sharePointUpload }}
      EMAIL_RECIPIENTS: ${{ parameters.emailRecipients }}
    
    steps:
    - script: |
        echo "üìä REPORT GENERATION TEMPLATE v1.0"
        echo "=================================="
        echo "Report Title: $(REPORT_TITLE)"
        echo "Include Charts: $(INCLUDE_CHARTS)"
        echo "Generate PDF: $(GENERATE_PDF)"
        echo "Notifications: $(NOTIFICATION_ENABLED)"
        echo "SharePoint Upload: $(SHAREPOINT_UPLOAD)"
        echo "Email Recipients: $(EMAIL_RECIPIENTS)"
        echo "Report Formats: ${{ join(',', parameters.reportFormats) }}"
        echo ""
        
        # Validate report title
        if [ -z "$(REPORT_TITLE)" ]; then
          echo "‚ùå ERROR: Report title cannot be empty"
          exit 1
        fi
        
        # Validate email format if provided
        if [ -n "$(EMAIL_RECIPIENTS)" ]; then
          echo "üìß Validating email recipients..."
          for email in $(echo "$(EMAIL_RECIPIENTS)" | tr ',' ' '); do
            if ! echo "$email" | grep -E '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' > /dev/null; then
              echo "‚ö†Ô∏è WARNING: Invalid email format: $email"
            else
              echo "‚úÖ Valid email: $email"
            fi
          done
        fi
        
        echo "‚úÖ Parameter validation passed"
        
      displayName: 'Validate Template Parameters'
    
    - task: DownloadBuildArtifacts@1
      displayName: 'Download Analysis Results'
      inputs:
        buildType: 'current'
        downloadType: 'specific'
        downloadPath: '$(System.ArtifactsDirectory)'
    
    - script: |
        echo "üìÅ COLLECTING ANALYSIS ARTIFACTS"
        echo "================================"
        
        # List all available artifacts
        echo "üìã Available artifacts:"
        find "$(System.ArtifactsDirectory)" -type f -name "*.md" -o -name "*.json" -o -name "*.txt" | sort
        echo ""
        
        # Collect analysis files
        ANALYSIS_FILES=""
        
        # Check for markdown analysis
        if [ -f "$(System.ArtifactsDirectory)/AnalysisReportMarkdown/analysis_report.md" ]; then
          cp "$(System.ArtifactsDirectory)/AnalysisReportMarkdown/analysis_report.md" .
          ANALYSIS_FILES="$ANALYSIS_FILES analysis_report.md"
          echo "‚úÖ Markdown analysis found"
        fi
        
        # Check for JSON analysis
        if [ -f "$(System.ArtifactsDirectory)/AnalysisReportJSON/analysis_report.json" ]; then
          cp "$(System.ArtifactsDirectory)/AnalysisReportJSON/analysis_report.json" .
          ANALYSIS_FILES="$ANALYSIS_FILES analysis_report.json"
          echo "‚úÖ JSON analysis found"
        fi
        
        # Check for executive summary
        if [ -f "$(System.ArtifactsDirectory)/ExecutiveSummary/executive_summary.md" ]; then
          cp "$(System.ArtifactsDirectory)/ExecutiveSummary/executive_summary.md" .
          ANALYSIS_FILES="$ANALYSIS_FILES executive_summary.md"
          echo "‚úÖ Executive summary found"
        fi
        
        # Check for raw analysis
        if [ -f "$(System.ArtifactsDirectory)/RawAnalysis/ai_analysis_raw.txt" ]; then
          cp "$(System.ArtifactsDirectory)/RawAnalysis/ai_analysis_raw.txt" .
          ANALYSIS_FILES="$ANALYSIS_FILES ai_analysis_raw.txt"
          echo "‚úÖ Raw analysis found"
        fi
        
        # Check for work items data
        if [ -f "$(System.ArtifactsDirectory)/WorkItemsData/work_items_final.json" ]; then
          cp "$(System.ArtifactsDirectory)/WorkItemsData/work_items_final.json" .
          ANALYSIS_FILES="$ANALYSIS_FILES work_items_final.json"
          echo "‚úÖ Work items data found"
        fi
        
        # Check for work items summary
        if [ -f "$(System.ArtifactsDirectory)/WorkItemsSummary/work_items_summary.txt" ]; then
          cp "$(System.ArtifactsDirectory)/WorkItemsSummary/work_items_summary.txt" .
          ANALYSIS_FILES="$ANALYSIS_FILES work_items_summary.txt"
          echo "‚úÖ Work items summary found"
        fi
        
        if [ -z "$ANALYSIS_FILES" ]; then
          echo "‚ùå ERROR: No analysis files found"
          echo "üí° Ensure previous stages completed successfully"
          exit 1
        fi
        
        # Save file list for next steps
        echo "$ANALYSIS_FILES" > available_files.txt
        
        echo ""
        echo "üìä ARTIFACT COLLECTION SUMMARY"
        echo "=============================="
        echo "Available files: $(echo $ANALYSIS_FILES | wc -w)"
        echo "Files: $ANALYSIS_FILES"
        echo "‚úÖ All artifacts collected successfully"
        
      displayName: 'Collect Analysis Artifacts'
    
    - script: |
        echo "üìà GENERATING METRICS AND CHARTS"
        echo "==============================="
        
        # Skip charts if not requested
        if [ "$(INCLUDE_CHARTS)" != "True" ]; then
          echo "‚ÑπÔ∏è Chart generation skipped (INCLUDE_CHARTS=False)"
          exit 0
        fi
        
        # Check if work items data is available
        if [ ! -f work_items_final.json ]; then
          echo "‚ö†Ô∏è WARNING: No work items data available for charts"
          exit 0
        fi
        
        echo "üìä Extracting metrics for visualization..."
        
        # Extract basic metrics
        TOTAL_ITEMS=$(jq '.metadata.count' work_items_final.json)
        echo "Total Items: $TOTAL_ITEMS"
        
        # Generate state distribution
        echo "üìà Generating state distribution chart data..."
        jq -r '.workItems[] | .fields["System.State"] // "Unknown"' work_items_final.json | \
          sort | uniq -c | sort -nr > state_distribution.txt
        
        # Generate work item type distribution
        echo "üìà Generating work item type chart data..."
        jq -r '.workItems[] | .fields["System.WorkItemType"] // "Unknown"' work_items_final.json | \
          sort | uniq -c | sort -nr > type_distribution.txt
        
        # Generate assigned to distribution (top 10)
        echo "üìà Generating assignment distribution chart data..."
        jq -r '.workItems[] | .fields["System.AssignedTo"]["displayName"] // "Unassigned"' work_items_final.json 2>/dev/null | \
          sort | uniq -c | sort -nr | head -10 > assignment_distribution.txt
        
        # Generate priority distribution if available
        echo "üìà Generating priority distribution chart data..."
        jq -r '.workItems[] | .fields["Microsoft.VSTS.Common.Priority"] // "Unknown"' work_items_final.json 2>/dev/null | \
          sort | uniq -c | sort -nr > priority_distribution.txt
        
        # Create CSV files for chart generation tools
        echo "State,Count" > charts_state.csv
        awk '{print $2","$1}' state_distribution.txt >> charts_state.csv
        
        echo "Type,Count" > charts_type.csv
        awk '{print $2","$1}' type_distribution.txt >> charts_type.csv
        
        echo "AssignedTo,Count" > charts_assignment.csv
        awk '{for(i=2;i<=NF;i++) printf "%s ", $i; print ","$1}' assignment_distribution.txt | sed 's/ ,/,/g' >> charts_assignment.csv
        
        # Generate simple HTML charts using Chart.js
        cat > charts.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>Backlog Analysis Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .chart-container { width: 48%; display: inline-block; margin: 1%; }
        .chart-title { text-align: center; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>$(REPORT_TITLE) - Visual Charts</h1>
    
    <div class="chart-container">
        <div class="chart-title">Work Items by State</div>
        <canvas id="stateChart"></canvas>
    </div>
    
    <div class="chart-container">
        <div class="chart-title">Work Items by Type</div>
        <canvas id="typeChart"></canvas>
    </div>
    
    <div class="chart-container">
        <div class="chart-title">Work Items by Assignment</div>
        <canvas id="assignmentChart"></canvas>
    </div>
    
    <script>
        // State distribution chart
        const stateData = $(cat charts_state.csv | tail -n +2 | awk -F',' '{print "{label:\""$1"\",value:"$2"}"}' | paste -sd',');
        
        new Chart(document.getElementById('stateChart'), {
            type: 'pie',
            data: {
                labels: [$(cat charts_state.csv | tail -n +2 | cut -d',' -f1 | sed 's/.*/\"&\"/' | paste -sd',')],
                datasets: [{
                    data: [$(cat charts_state.csv | tail -n +2 | cut -d',' -f2 | paste -sd',')],
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
        
        // Type distribution chart
        new Chart(document.getElementById('typeChart'), {
            type: 'doughnut',
            data: {
                labels: [$(cat charts_type.csv | tail -n +2 | cut -d',' -f1 | sed 's/.*/\"&\"/' | paste -sd',')],
                datasets: [{
                    data: [$(cat charts_type.csv | tail -n +2 | cut -d',' -f2 | paste -sd',')],
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
        
        // Assignment distribution chart
        new Chart(document.getElementById('assignmentChart'), {
            type: 'bar',
            data: {
                labels: [$(cat charts_assignment.csv | tail -n +2 | cut -d',' -f1 | sed 's/.*/\"&\"/' | paste -sd',')],
                datasets: [{
                    label: 'Work Items',
                    data: [$(cat charts_assignment.csv | tail -n +2 | cut -d',' -f2 | paste -sd',')],
                    backgroundColor: '#36A2EB'
                }]
            },
            options: { 
                responsive: true, 
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
    </script>
</body>
</html>
EOF
        
        echo "‚úÖ Charts generated: charts.html"
        echo "‚úÖ Chart data files created (CSV format)"
        echo "‚úÖ Metrics extraction completed"
        
      displayName: 'Generate Metrics and Charts'
    
    - script: |
        echo "üìù CREATING COMPREHENSIVE REPORTS"
        echo "================================="
        
        # Get current timestamp
        TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        REPORT_DATE=$(date -u +"%B %d, %Y")
        
        # Extract metadata if available
        if [ -f work_items_final.json ]; then
          ORGANIZATION=$(jq -r '.metadata.organization' work_items_final.json)
          PROJECT=$(jq -r '.metadata.project' work_items_final.json)
          WORK_ITEM_COUNT=$(jq '.metadata.count' work_items_final.json)
        else
          ORGANIZATION="Unknown"
          PROJECT="Unknown"
          WORK_ITEM_COUNT="Unknown"
        fi
        
        # Generate HTML report if requested
        if echo "${{ join(',', parameters.reportFormats) }}" | grep -q "html"; then
          echo "üìÑ Generating HTML report..."
          
          cat > comprehensive_report.html << EOF
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$(REPORT_TITLE)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 { margin: 0; font-size: 2.5em; }
        .header .subtitle { font-size: 1.2em; opacity: 0.9; margin-top: 10px; }
        .metadata {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .metadata h2 { color: #667eea; margin-top: 0; }
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .metadata-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        .metadata-item strong { color: #333; }
        .content-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .content-section h2 {
            color: #667eea;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .analysis-content {
            font-size: 1.1em;
            line-height: 1.8;
        }
        .analysis-content h3 { color: #555; margin-top: 25px; }
        .analysis-content ul, .analysis-content ol { margin: 15px 0; }
        .analysis-content li { margin: 8px 0; }
        .charts-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        .footer {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 0.9em;
        }
        .executive-summary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .executive-summary h2 { margin-top: 0; color: white; }
        @media print {
            body { background: white; }
            .header, .content-section, .metadata, .charts-section, .executive-summary {
                box-shadow: none;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>$(REPORT_TITLE)</h1>
        <div class="subtitle">Azure DevOps Backlog Analysis Report</div>
        <div class="subtitle">Generated on $REPORT_DATE</div>
    </div>

    <div class="metadata">
        <h2>üìä Analysis Overview</h2>
        <div class="metadata-grid">
            <div class="metadata-item">
                <strong>Organization:</strong><br>$ORGANIZATION
            </div>
            <div class="metadata-item">
                <strong>Project:</strong><br>$PROJECT
            </div>
            <div class="metadata-item">
                <strong>Work Items:</strong><br>$WORK_ITEM_COUNT
            </div>
            <div class="metadata-item">
                <strong>Generated:</strong><br>$TIMESTAMP
            </div>
        </div>
    </div>
EOF

          # Add executive summary if available
          if [ -f executive_summary.md ]; then
            echo "    <div class=\"executive-summary\">" >> comprehensive_report.html
            echo "        <h2>üéØ Executive Summary</h2>" >> comprehensive_report.html
            echo "        <div class=\"analysis-content\">" >> comprehensive_report.html
            # Convert markdown to basic HTML
            sed 's/^# /\<h3\>/g; s/^## /\<h4\>/g; s/^- /\<li\>/g; s/^\* /\<li\>/g' executive_summary.md | \
            sed 's/\*\*\([^*]*\)\*\*/\<strong\>\1\<\/strong\>/g' >> comprehensive_report.html
            echo "        </div>" >> comprehensive_report.html
            echo "    </div>" >> comprehensive_report.html
          fi

          # Add main analysis content
          cat >> comprehensive_report.html << EOF
    <div class="content-section">
        <h2>ü§ñ AI Analysis Results</h2>
        <div class="analysis-content">
EOF

          if [ -f analysis_report.md ]; then
            # Convert markdown to basic HTML (simplified)
            sed 's/^# /\<h3\>/g; s/^## /\<h4\>/g; s/^### /\<h5\>/g; s/^- /\<li\>/g; s/^\* /\<li\>/g' analysis_report.md | \
            sed 's/\*\*\([^*]*\)\*\*/\<strong\>\1\<\/strong\>/g; s/\*\([^*]*\)\*/\<em\>\1\<\/em\>/g' >> comprehensive_report.html
          elif [ -f ai_analysis_raw.txt ]; then
            echo "<pre>" >> comprehensive_report.html
            cat ai_analysis_raw.txt >> comprehensive_report.html
            echo "</pre>" >> comprehensive_report.html
          else
            echo "<p>Analysis content not available.</p>" >> comprehensive_report.html
          fi

          cat >> comprehensive_report.html << EOF
        </div>
    </div>
EOF

          # Add charts section if available
          if [ "$(INCLUDE_CHARTS)" = "True" ] && [ -f charts.html ]; then
            cat >> comprehensive_report.html << EOF
    <div class="charts-section">
        <h2>üìà Visual Analysis</h2>
        <p><a href="charts.html" target="_blank">View Interactive Charts</a></p>
        <p><em>Charts provide visual representation of work item distributions and trends.</em></p>
    </div>
EOF
          fi

          # Add footer
          cat >> comprehensive_report.html << EOF
    <div class="footer">
        <p><strong>Generated by GitHub Copilot Backlog Analyzer</strong></p>
        <p>Azure DevOps Organization: $ORGANIZATION | Project: $PROJECT</p>
        <p>Analysis Timestamp: $TIMESTAMP</p>
    </div>
</body>
</html>
EOF

          echo "‚úÖ HTML report generated: comprehensive_report.html"
        fi

        # Generate enhanced markdown report if requested
        if echo "${{ join(',', parameters.reportFormats) }}" | grep -q "markdown"; then
          echo "üìÑ Generating enhanced Markdown report..."
          
          cat > enhanced_report.md << EOF
# $(REPORT_TITLE)

**Azure DevOps Backlog Analysis Report**  
*Generated on $REPORT_DATE*

## üìä Analysis Overview

| Attribute | Value |
|-----------|-------|
| **Organization** | $ORGANIZATION |
| **Project** | $PROJECT |
| **Work Items Analyzed** | $WORK_ITEM_COUNT |
| **Analysis Timestamp** | $TIMESTAMP |
| **Report Format** | Enhanced Markdown |

---

EOF

          # Add executive summary if available
          if [ -f executive_summary.md ]; then
            echo "## üéØ Executive Summary" >> enhanced_report.md
            echo "" >> enhanced_report.md
            tail -n +2 executive_summary.md >> enhanced_report.md
            echo "" >> enhanced_report.md
            echo "---" >> enhanced_report.md
            echo "" >> enhanced_report.md
          fi

          # Add main analysis
          echo "## ü§ñ AI Analysis Results" >> enhanced_report.md
          echo "" >> enhanced_report.md
          if [ -f analysis_report.md ]; then
            tail -n +2 analysis_report.md >> enhanced_report.md
          elif [ -f ai_analysis_raw.txt ]; then
            echo "### Analysis Output" >> enhanced_report.md
            echo "" >> enhanced_report.md
            echo "\`\`\`" >> enhanced_report.md
            cat ai_analysis_raw.txt >> enhanced_report.md
            echo "\`\`\`" >> enhanced_report.md
          fi

          # Add charts reference if available
          if [ "$(INCLUDE_CHARTS)" = "True" ] && [ -f charts.html ]; then
            echo "" >> enhanced_report.md
            echo "## üìà Visual Analysis" >> enhanced_report.md
            echo "" >> enhanced_report.md
            echo "Interactive charts are available in the \`charts.html\` file." >> enhanced_report.md
            echo "" >> enhanced_report.md
          fi

          # Add footer
          cat >> enhanced_report.md << EOF

---

## üìã Report Information

- **Generated by:** GitHub Copilot Backlog Analyzer
- **Source:** Azure DevOps ($ORGANIZATION/$PROJECT)
- **Timestamp:** $TIMESTAMP
- **Format:** Enhanced Markdown Report

*This report was automatically generated using AI analysis of Azure DevOps work items.*
EOF

          echo "‚úÖ Enhanced Markdown report generated: enhanced_report.md"
        fi

        echo ""
        echo "üìä REPORT GENERATION SUMMARY"
        echo "============================"
        echo "‚úÖ Report formats generated: ${{ join(',', parameters.reportFormats) }}"
        echo "‚úÖ Charts included: $(INCLUDE_CHARTS)"
        echo "‚úÖ All reports ready for publication"

      displayName: 'Create Comprehensive Reports'
    
    - script: |
        echo "üìß PROCESSING NOTIFICATIONS"
        echo "=========================="
        
        # Skip notifications if disabled
        if [ "$(NOTIFICATION_ENABLED)" != "True" ]; then
          echo "‚ÑπÔ∏è Notifications disabled, skipping notification processing"
          exit 0
        fi
        
        # Prepare notification content
        NOTIFICATION_TITLE="$(REPORT_TITLE) - Analysis Complete"
        NOTIFICATION_BODY="Backlog analysis has been completed successfully.

Organization: $ORGANIZATION
Project: $PROJECT
Work Items Analyzed: $WORK_ITEM_COUNT
Analysis Timestamp: $TIMESTAMP

The comprehensive report is available in the pipeline artifacts."

        # Create notification summary
        cat > notification_summary.txt << EOF
NOTIFICATION SUMMARY
===================

Title: $NOTIFICATION_TITLE

Body:
$NOTIFICATION_BODY

Recipients: $(EMAIL_RECIPIENTS)
SharePoint Upload: $(SHAREPOINT_UPLOAD)
Generated: $TIMESTAMP
EOF

        echo "üìß Notification summary prepared"
        
        # Email notification processing
        if [ -n "$(EMAIL_RECIPIENTS)" ]; then
          echo "üìß Email notification requested for: $(EMAIL_RECIPIENTS)"
          
          # Create email content file
          cat > email_content.html << EOF
<!DOCTYPE html>
<html>
<head>
    <title>$NOTIFICATION_TITLE</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .header { background: #667eea; color: white; padding: 20px; text-align: center; }
        .content { padding: 20px; }
        .metadata { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .footer { background: #f8f9fa; padding: 15px; text-align: center; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="header">
        <h1>$NOTIFICATION_TITLE</h1>
    </div>
    <div class="content">
        <p>The Azure DevOps backlog analysis has been completed successfully.</p>
        
        <div class="metadata">
            <h3>Analysis Details</h3>
            <ul>
                <li><strong>Organization:</strong> $ORGANIZATION</li>
                <li><strong>Project:</strong> $PROJECT</li>
                <li><strong>Work Items:</strong> $WORK_ITEM_COUNT</li>
                <li><strong>Completed:</strong> $TIMESTAMP</li>
            </ul>
        </div>
        
        <p>The comprehensive analysis report is available in the Azure DevOps pipeline artifacts. 
           Please access the pipeline run to download the full report and supporting materials.</p>
    </div>
    <div class="footer">
        <p>Generated by GitHub Copilot Backlog Analyzer</p>
        <p>Azure DevOps: $ORGANIZATION/$PROJECT</p>
    </div>
</body>
</html>
EOF

          echo "‚úÖ Email content prepared: email_content.html"
        else
          echo "‚ÑπÔ∏è No email recipients specified"
        fi
        
        # SharePoint upload preparation
        if [ "$(SHAREPOINT_UPLOAD)" = "True" ]; then
          echo "üì§ SharePoint upload requested"
          
          # Create SharePoint upload manifest
          cat > sharepoint_manifest.json << EOF
{
  "uploadRequested": true,
  "timestamp": "$TIMESTAMP",
  "reportTitle": "$(REPORT_TITLE)",
  "organization": "$ORGANIZATION",
  "project": "$PROJECT",
  "workItemCount": "$WORK_ITEM_COUNT",
  "files": [
EOF

          # Add available files to manifest
          FILES_ADDED=false
          for file in comprehensive_report.html enhanced_report.md charts.html; do
            if [ -f "$file" ]; then
              if [ "$FILES_ADDED" = true ]; then
                echo "," >> sharepoint_manifest.json
              fi
              echo "    {\"filename\": \"$file\", \"type\": \"report\"}" >> sharepoint_manifest.json
              FILES_ADDED=true
            fi
          done

          cat >> sharepoint_manifest.json << EOF
  ],
  "metadata": {
    "analysisMode": "Generated Report",
    "includeCharts": $(INCLUDE_CHARTS),
    "generatePDF": $(GENERATE_PDF)
  }
}
EOF

          echo "‚úÖ SharePoint manifest prepared: sharepoint_manifest.json"
        else
          echo "‚ÑπÔ∏è SharePoint upload not requested"
        fi
        
        echo "‚úÖ Notification processing completed"
        
      displayName: 'Process Notifications'
    
    - script: |
        echo "üì¶ GENERATING PDF REPORT"
        echo "======================="
        
        # Skip PDF generation if not requested
        if [ "$(GENERATE_PDF)" != "True" ]; then
          echo "‚ÑπÔ∏è PDF generation skipped (GENERATE_PDF=False)"
          exit 0
        fi
        
        # Install pandoc for PDF generation
        echo "üì¶ Installing pandoc for PDF generation..."
        sudo apt-get update && sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-extra-utils texlive-latex-extra
        
        # Check if we have markdown content for PDF
        if [ -f enhanced_report.md ]; then
          echo "üìÑ Converting enhanced markdown to PDF..."
          
          # Create pandoc template for better formatting
          cat > pdf_template.yaml << EOF
---
title: "$(REPORT_TITLE)"
subtitle: "Azure DevOps Backlog Analysis Report"
author: "GitHub Copilot Backlog Analyzer"
date: "$REPORT_DATE"
geometry: margin=1in
fontsize: 11pt
colorlinks: true
linkcolor: blue
urlcolor: blue
toccolor: black
---
EOF

          # Combine template with content
          cat pdf_template.yaml enhanced_report.md > pdf_source.md
          
          # Generate PDF
          if pandoc pdf_source.md -o "$(REPORT_TITLE)_Report.pdf" --pdf-engine=pdflatex --toc; then
            echo "‚úÖ PDF report generated: $(REPORT_TITLE)_Report.pdf"
            
            # Validate PDF
            PDF_SIZE=$(wc -c < "$(REPORT_TITLE)_Report.pdf")
            echo "üìä PDF size: $PDF_SIZE bytes"
            
            if [ $PDF_SIZE -gt 1000 ]; then
              echo "‚úÖ PDF validation passed"
            else
              echo "‚ö†Ô∏è WARNING: PDF may be corrupted (size too small)"
            fi
          else
            echo "‚ùå PDF generation failed, creating fallback text file"
            cat enhanced_report.md > "$(REPORT_TITLE)_Report.txt"
            echo "‚úÖ Fallback text report created"
          fi
        else
          echo "‚ö†Ô∏è No markdown content available for PDF generation"
        fi
        
      displayName: 'Generate PDF Report'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish HTML Report'
      condition: and(succeeded(), contains('${{ join(',', parameters.reportFormats) }}', 'html'))
      inputs:
        pathToPublish: 'comprehensive_report.html'
        artifactName: 'HTMLReport'
        publishLocation: 'Container'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Enhanced Markdown Report'
      condition: and(succeeded(), contains('${{ join(',', parameters.reportFormats) }}', 'markdown'))
      inputs:
        pathToPublish: 'enhanced_report.md'
        artifactName: 'MarkdownReport'
        publishLocation: 'Container'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Interactive Charts'
      condition: and(succeeded(), eq(variables['INCLUDE_CHARTS'], 'True'))
      inputs:
        pathToPublish: 'charts.html'
        artifactName: 'InteractiveCharts'
        publishLocation: 'Container'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish PDF Report'
      condition: and(succeeded(), eq(variables['GENERATE_PDF'], 'True'))
      inputs:
        pathToPublish: '*.pdf'
        artifactName: 'PDFReport'
        publishLocation: 'Container'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Notification Content'
      condition: and(succeeded(), eq(variables['NOTIFICATION_ENABLED'], 'True'))
      inputs:
        pathToPublish: 'notification_summary.txt'
        artifactName: 'NotificationContent'
        publishLocation: 'Container'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish SharePoint Manifest'
      condition: and(succeeded(), eq(variables['SHAREPOINT_UPLOAD'], 'True'))
      inputs:
        pathToPublish: 'sharepoint_manifest.json'
        artifactName: 'SharePointManifest'
        publishLocation: 'Container'
    
    - script: |
        echo "üìã REPORT GENERATION TEMPLATE COMPLETION SUMMARY"
        echo "==============================================="
        echo "‚úÖ All requested report formats generated successfully"
        echo "‚úÖ Visual charts created and embedded (if requested)"
        echo "‚úÖ Notification content prepared (if enabled)"
        echo "‚úÖ All artifacts published for distribution"
        echo ""
        echo "üîß Generated Artifacts:"
        if echo "${{ join(',', parameters.reportFormats) }}" | grep -q "html"; then
          echo "   - HTMLReport (comprehensive_report.html)"
        fi
        if echo "${{ join(',', parameters.reportFormats) }}" | grep -q "markdown"; then
          echo "   - MarkdownReport (enhanced_report.md)"
        fi
        if [ "$(INCLUDE_CHARTS)" = "True" ]; then
          echo "   - InteractiveCharts (charts.html)"
        fi
        if [ "$(GENERATE_PDF)" = "True" ]; then
          echo "   - PDFReport ($(REPORT_TITLE)_Report.pdf)"
        fi
        if [ "$(NOTIFICATION_ENABLED)" = "True" ]; then
          echo "   - NotificationContent (notification_summary.txt)"
        fi
        if [ "$(SHAREPOINT_UPLOAD)" = "True" ]; then
          echo "   - SharePointManifest (sharepoint_manifest.json)"
        fi
        echo ""
        echo "üí° Report Distribution:"
        echo "   - Download artifacts from Azure DevOps pipeline"
        echo "   - Share HTML report for immediate viewing"
        echo "   - Use PDF for formal documentation"
        echo "   - Reference charts for presentations"
        echo ""
        echo "üéØ Analysis reporting complete - Ready for stakeholder distribution!"
        
      displayName: 'Report Generation Complete - Ready for Distribution'