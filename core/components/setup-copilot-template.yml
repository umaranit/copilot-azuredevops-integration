# Azure Pipeline Template: Setup GitHub Copilot CLI
# Reusable component for installing and authenticating GitHub Copilot CLI

parameters:
  - name: nodeVersion
    displayName: 'Node.js Version'
    type: string
    default: '22'
  
  - name: copilotVersion
    displayName: 'Copilot CLI Version'
    type: string
    default: '@github/copilot@latest'
  
  - name: maxRetryAttempts
    displayName: 'Maximum Retry Attempts'
    type: number
    default: 3
  
  - name: timeoutSeconds
    displayName: 'Installation Timeout (seconds)'
    type: number
    default: 300
  
  - name: validationLevel
    displayName: 'Validation Level'
    type: string
    default: 'standard'
    values:
      - 'basic'     # Simple connectivity test
      - 'standard'  # Full authentication testing
      - 'strict'    # Comprehensive validation

stages:
- stage: SetupCopilot
  displayName: 'Setup GitHub Copilot CLI'
  jobs:
  - job: InstallAndValidate
    displayName: 'Install & Validate Copilot CLI'
    timeoutInMinutes: ${{ parameters.timeoutSeconds }}
    variables:
      NODE_VERSION: ${{ parameters.nodeVersion }}
      COPILOT_VERSION: ${{ parameters.copilotVersion }}
      MAX_RETRIES: ${{ parameters.maxRetryAttempts }}
      VALIDATION_LEVEL: ${{ parameters.validationLevel }}
    
    steps:
    - script: |
        echo "ğŸ› ï¸ COPILOT CLI SETUP TEMPLATE v1.0"
        echo "=================================="
        echo "Node.js Version: $(NODE_VERSION)"
        echo "Copilot Version: $(COPILOT_VERSION)"
        echo "Max Retries: $(MAX_RETRIES)"
        echo "Validation Level: $(VALIDATION_LEVEL)"
        echo "Timeout: ${{ parameters.timeoutSeconds }} seconds"
        echo ""
        
        # Validate parameters
        if ! echo "$(NODE_VERSION)" | grep -E '^[0-9]+$' > /dev/null; then
          echo "âŒ ERROR: Invalid Node.js version format"
          exit 1
        fi
        
        if [ $(NODE_VERSION) -lt 18 ]; then
          echo "âŒ ERROR: Node.js version must be 18 or higher"
          exit 1
        fi
        
        echo "âœ… Parameter validation passed"
        
      displayName: 'Validate Template Parameters'
    
    - script: |
        echo "ğŸ“¦ INSTALLING NODE.JS AND DEPENDENCIES"
        echo "====================================="
        
        # Function for retries
        retry_command() {
          local cmd="$1"
          local description="$2"
          local max_attempts=$(MAX_RETRIES)
          local attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ”„ Attempt $attempt/$max_attempts: $description"
            if eval "$cmd"; then
              echo "âœ… $description succeeded on attempt $attempt"
              return 0
            else
              echo "âŒ $description failed on attempt $attempt"
              if [ $attempt -eq $max_attempts ]; then
                echo "ğŸ’¥ $description failed after $max_attempts attempts"
                return 1
              fi
              echo "â³ Waiting 10 seconds before retry..."
              sleep 10
              attempt=$((attempt + 1))
            fi
          done
        }
        
        # Install Node.js with retry
        retry_command "curl -fsSL https://deb.nodesource.com/setup_$(NODE_VERSION).x | sudo -E bash -" "Node.js repository setup"
        retry_command "sudo apt-get update && sudo apt-get install -y nodejs jq curl bc" "Package installation"
        
        # Verify installations
        echo ""
        echo "ğŸ“‹ VERIFYING INSTALLATIONS"
        echo "========================="
        echo "Node.js version: $(node --version)"
        echo "npm version: $(npm --version)"
        echo "jq version: $(jq --version)"
        
        # Validate Node.js version
        NODE_MAJOR=$(node --version | cut -d'.' -f1 | sed 's/v//')
        if [ "$NODE_MAJOR" -lt $(NODE_VERSION) ]; then
          echo "âŒ ERROR: Node.js version validation failed"
          echo "Expected: $(NODE_VERSION), Got: $NODE_MAJOR"
          exit 1
        fi
        
        echo "âœ… Node.js and dependencies ready"
        
      displayName: 'Install Node.js and Dependencies'
    
    - script: |
        echo "ğŸš€ INSTALLING GITHUB COPILOT CLI"
        echo "==============================="
        
        # Install with retry and validation
        install_copilot() {
          local max_attempts=$(MAX_RETRIES)
          local attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ“¦ Installing Copilot CLI (attempt $attempt/$max_attempts)..."
            
            # Clear npm cache if not first attempt
            if [ $attempt -gt 1 ]; then
              echo "ğŸ§¹ Clearing npm cache..."
              sudo npm cache clean --force || true
            fi
            
            if sudo npm install -g $(COPILOT_VERSION) --timeout=120000 --verbose; then
              echo "âœ… Copilot CLI installed successfully"
              return 0
            else
              echo "âŒ Installation failed on attempt $attempt"
              if [ $attempt -eq $max_attempts ]; then
                echo "ğŸ’¥ Copilot CLI installation failed after $max_attempts attempts"
                echo "ğŸ” Troubleshooting information:"
                echo "   - npm version: $(npm --version)"
                echo "   - Node.js version: $(node --version)"
                echo "   - Available disk space: $(df -h / | tail -1 | awk '{print $4}')"
                return 1
              fi
              sleep 15
              attempt=$((attempt + 1))
            fi
          done
        }
        
        install_copilot
        
        # Verify installation
        echo ""
        echo "ğŸ” VERIFYING COPILOT CLI INSTALLATION"
        echo "==================================="
        
        # Check if copilot command exists
        if ! which copilot > /dev/null; then
          echo "âŒ ERROR: Copilot CLI not found in PATH"
          echo "ğŸ” Searching for copilot executable..."
          find /usr -name "*copilot*" 2>/dev/null | head -5 || true
          exit 1
        fi
        
        echo "âœ… Copilot CLI found at: $(which copilot)"
        
        # Test basic functionality (version check may not work in all versions)
        echo "ğŸ§ª Testing basic functionality..."
        copilot --version 2>/dev/null || echo "âš ï¸ Version check unavailable (this is normal for some versions)"
        
        echo "âœ… GitHub Copilot CLI installation complete"
        
      displayName: 'Install GitHub Copilot CLI'
    
    - script: |
        echo "ğŸ” TESTING COPILOT AUTHENTICATION"
        echo "================================"
        
        # Set environment variables
        export GITHUB_TOKEN="$(GITHUB_TOKEN)"
        export GH_TOKEN="$(GITHUB_TOKEN)"
        
        # Validation level determines test depth
        case "$(VALIDATION_LEVEL)" in
          "basic")
            TEST_SCENARIOS=("What is 1+1? Just respond with the number.")
            TEST_TIMEOUTS=(10)
            ;;
          "standard")
            TEST_SCENARIOS=(
              "What is 1+1? Just respond with the number."
              "Say 'HELLO' in uppercase."
              "Analyze this text: 'Good morning' - respond with 'ANALYZED'"
            )
            TEST_TIMEOUTS=(10 15 20)
            ;;
          "strict")
            TEST_SCENARIOS=(
              "What is 1+1? Just respond with the number."
              "Say 'HELLO' in uppercase."
              "Analyze this text: 'Good morning' - respond with 'ANALYZED'"
              "Review this user story: 'As a user I want to login' - rate 1-10"
              "Generate a brief summary of this: 'Product backlog management' - max 10 words"
            )
            TEST_TIMEOUTS=(10 15 20 30 25)
            ;;
        esac
        
        # Enhanced token validation
        if [ -z "$GITHUB_TOKEN" ]; then
          echo "âŒ CRITICAL ERROR: GITHUB_TOKEN is not set!"
          echo "ğŸ’¡ Ensure the 'copilot-credentials' variable group exists with GITHUB_TOKEN"
          exit 1
        fi
        
        # Validate token format
        if ! echo "$GITHUB_TOKEN" | grep -E '^gh[pousr]_[A-Za-z0-9_]{36,}$' > /dev/null; then
          echo "âš ï¸ WARNING: GITHUB_TOKEN format may be invalid"
          echo "Expected format: ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
          echo "Token length: ${#GITHUB_TOKEN}"
        else
          echo "âœ… GITHUB_TOKEN format validation passed"
        fi
        
        echo "ğŸ”‘ GITHUB_TOKEN is set (length: ${#GITHUB_TOKEN})"
        
        # Progressive authentication tests
        run_copilot_test() {
          local prompt="$1"
          local timeout="$2"
          local test_num="$3"
          local total_tests="$4"
          
          echo ""
          echo "ğŸ§ª Test $test_num/$total_tests: Testing with prompt (timeout: ${timeout}s)"
          echo "ğŸ“ Prompt: $prompt"
          
          local result
          result=$(echo "$prompt" | timeout "$timeout" copilot 2>&1)
          local exit_code=$?
          
          case $exit_code in
            0)
              echo "âœ… Test $test_num passed successfully"
              echo "ğŸ“¤ Response preview: $(echo "$result" | head -c 100)..."
              return 0
              ;;
            124)
              echo "â° Test $test_num timed out after ${timeout}s"
              echo "ğŸ’¡ This may indicate slow network or Copilot service issues"
              return 1
              ;;
            *)
              echo "âŒ Test $test_num failed (exit code: $exit_code)"
              echo "ğŸ“¤ Error output: $result"
              return 1
              ;;
          esac
        }
        
        # Execute test suite based on validation level
        echo "ğŸ¯ Running $(VALIDATION_LEVEL) validation test suite..."
        echo "ğŸ“Š Total tests planned: ${#TEST_SCENARIOS[@]}"
        
        PASSED_TESTS=0
        TOTAL_TESTS=${#TEST_SCENARIOS[@]}
        
        for i in "${!TEST_SCENARIOS[@]}"; do
          if run_copilot_test "${TEST_SCENARIOS[$i]}" "${TEST_TIMEOUTS[$i]}" "$((i+1))" "$TOTAL_TESTS"; then
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            # For basic validation, any failure is critical
            if [ "$(VALIDATION_LEVEL)" = "basic" ]; then
              echo "ğŸ’¥ CRITICAL: Basic validation failed - cannot proceed"
              exit 1
            fi
          fi
        done
        
        # Calculate success rate
        SUCCESS_RATE=$(echo "scale=1; $PASSED_TESTS * 100 / $TOTAL_TESTS" | bc)
        
        echo ""
        echo "ğŸ“Š VALIDATION RESULTS"
        echo "===================="
        echo "Validation Level: $(VALIDATION_LEVEL)"
        echo "Tests Passed: $PASSED_TESTS/$TOTAL_TESTS"
        echo "Success Rate: $SUCCESS_RATE%"
        
        # Determine if validation passed based on level
        case "$(VALIDATION_LEVEL)" in
          "basic")
            MIN_SUCCESS=100  # Must pass all tests
            ;;
          "standard")
            MIN_SUCCESS=80   # 80% success rate required
            ;;
          "strict")
            MIN_SUCCESS=90   # 90% success rate required
            ;;
        esac
        
        if (( $(echo "$SUCCESS_RATE >= $MIN_SUCCESS" | bc -l) )); then
          echo "âœ… Validation PASSED (${SUCCESS_RATE}% >= ${MIN_SUCCESS}%)"
          echo "ğŸ‰ GitHub Copilot CLI is ready for analysis workflows!"
        else
          echo "âŒ Validation FAILED (${SUCCESS_RATE}% < ${MIN_SUCCESS}%)"
          echo "ğŸ’¡ Troubleshooting steps:"
          echo "   1. Verify GitHub token has Copilot access"
          echo "   2. Check Copilot subscription is active"
          echo "   3. Ensure network connectivity to GitHub"
          echo "   4. Try running with lower validation level"
          exit 1
        fi
        
      displayName: 'Test Copilot Authentication & Functionality'
      env:
        GITHUB_TOKEN: $(GITHUB_TOKEN)
        GH_TOKEN: $(GITHUB_TOKEN)
    
    - script: |
        echo "ğŸ“‹ SETUP TEMPLATE COMPLETION SUMMARY"
        echo "==================================="
        echo "âœ… Node.js $(NODE_VERSION) installed and verified"
        echo "âœ… GitHub Copilot CLI $(COPILOT_VERSION) installed"
        echo "âœ… Authentication validated at $(VALIDATION_LEVEL) level"
        echo "âœ… Ready for downstream analysis workflows"
        echo ""
        echo "ğŸ”§ Environment Details:"
        echo "   Node.js: $(node --version)"
        echo "   npm: $(npm --version)"
        echo "   Copilot CLI: $(which copilot)"
        echo "   Validation: $(VALIDATION_LEVEL)"
        echo ""
        echo "ğŸ’¡ Usage in downstream workflows:"
        echo "   - GITHUB_TOKEN environment variable is configured"
        echo "   - copilot command is available in PATH"
        echo "   - Authentication has been validated"
        echo ""
        echo "ğŸ¯ This template can be reused across multiple analysis workflows!"
        
      displayName: 'Setup Complete - Ready for Analysis'