# Sample Project Configuration - E-commerce Team
# Real-world example for a product development team

trigger:
  schedules:
  - cron: "0 9 * * 1"  # Every Monday at 9 AM
    displayName: Weekly Backlog Review
    branches:
      include:
      - main
    always: true

pool:
  vmImage: 'ubuntu-latest'

parameters:
  - name: analyzeTop
    displayName: 'Number of work items to analyze'
    type: number
    default: 15  # Medium-sized team
  
  - name: projectName
    displayName: 'Azure DevOps Project Name'
    type: string
    default: 'E-Commerce Platform'
  
  - name: workItemTypes
    displayName: 'Work Item Types'
    type: string
    default: 'Epic,Feature,User Story'  # Full hierarchy
  
  - name: analysisMode
    displayName: 'Analysis Focus'
    type: string
    default: 'Comprehensive'  # Full analysis for strategic planning

variables:
  - group: 'copilot-credentials'
  
  # Team-specific configuration
  - name: PROJECT_NAME_ENCODED
    value: 'E-Commerce%20Platform'
  
  # Performance optimized for larger analysis
  - name: COPILOT_TIMEOUT
    value: 90  # More time for comprehensive analysis
  - name: API_TIMEOUT
    value: 45
  
  # Team area filter
  - name: ADDITIONAL_WIQL_FILTERS
    value: "AND [System.AreaPath] UNDER 'E-Commerce Platform\\Product Development'"
  
  # Notification settings
  - name: TEAMS_WEBHOOK
    value: 'https://yourcompany.webhook.office.com/webhookb2/...'  # Optional Teams notification

stages:
- stage: Setup
  displayName: 'Setup & Validation'
  jobs:
  - job: PrepareEnvironment
    displayName: 'Setup Analysis Environment'
    steps:
    # ... (use main pipeline template steps)

# Additional customization for this team
- stage: PostAnalysis
  displayName: 'Post-Analysis Actions'
  dependsOn: AIAnalysis
  condition: succeeded()
  jobs:
  - job: TeamNotification
    displayName: 'Notify Team'
    steps:
    - script: |
        # Send Teams notification (if webhook configured)
        if [ -n "$(TEAMS_WEBHOOK)" ]; then
          curl -X POST $(TEAMS_WEBHOOK) \
            -H "Content-Type: application/json" \
            -d '{
              "title": "Backlog Analysis Complete",
              "text": "Weekly analysis for E-Commerce Platform is ready. Check pipeline artifacts for detailed report.",
              "themeColor": "0078D4"
            }'
        fi
        
        # Create summary for leadership
        echo "ðŸ“Š Executive Summary for $(date '+%Y-%m-%d')" > executive-summary.md
        echo "" >> executive-summary.md
        echo "- **Project:** E-Commerce Platform" >> executive-summary.md
        echo "- **Items Analyzed:** ${{ parameters.analyzeTop }}" >> executive-summary.md
        echo "- **Analysis Type:** ${{ parameters.analysisMode }}" >> executive-summary.md
        echo "- **Pipeline Run:** $(Build.BuildId)" >> executive-summary.md
        echo "" >> executive-summary.md
        echo "**Action Items:**" >> executive-summary.md
        echo "1. Product Owner to review quality scores below 7/10" >> executive-summary.md
        echo "2. Schedule backlog refinement for flagged items" >> executive-summary.md
        echo "3. Track improvement trends month-over-month" >> executive-summary.md
        
      displayName: 'Create Executive Summary'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Executive Summary'
      inputs:
        pathToPublish: 'executive-summary.md'
        artifactName: 'executive-summary'

# Team-specific WIQL customization
- stage: CustomAnalysis
  displayName: 'Custom Team Analysis'
  dependsOn: ExtractData
  condition: succeeded()
  jobs:
  - job: HighPriorityAnalysis
    displayName: 'Analyze High Priority Items'
    steps:
    - script: |
        # Additional analysis for P0/P1 items
        echo "ðŸš¨ Analyzing high-priority items separately..."
        
        # Custom WIQL for urgent items
        cat > high-priority-query.json << EOF
        {
          "query": "SELECT [System.Id], [System.Title], [System.WorkItemType] FROM WorkItems WHERE [System.TeamProject] = 'E-Commerce Platform' AND [Microsoft.VSTS.Common.Priority] <= 2 AND [System.State] IN ('New', 'Active', 'Committed') ORDER BY [Microsoft.VSTS.Common.Priority]"
        }
        EOF
        
        # Execute high-priority query
        curl -s -X POST \
             -H "Authorization: Bearer $(System.AccessToken)" \
             -H "Content-Type: application/json" \
             -d @high-priority-query.json \
             "$(System.CollectionUri)$(PROJECT_NAME_ENCODED)/_apis/wit/wiql?api-version=7.0" \
             -o high-priority-items.json
        
        HIGH_PRIORITY_COUNT=$(cat high-priority-items.json | jq '.workItems | length')
        echo "ðŸ“‹ Found $HIGH_PRIORITY_COUNT high-priority items requiring immediate attention"
        
        # Flag for leadership if too many high-priority items
        if [ "$HIGH_PRIORITY_COUNT" -gt 10 ]; then
          echo "âš ï¸ WARNING: $HIGH_PRIORITY_COUNT high-priority items may indicate capacity issues"
          echo "##vso[task.logissue type=warning]High priority item count ($HIGH_PRIORITY_COUNT) exceeds recommended threshold (10)"
        fi
        
      displayName: 'High Priority Item Analysis'