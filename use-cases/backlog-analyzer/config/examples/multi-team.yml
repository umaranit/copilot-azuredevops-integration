# Multi-Team Enterprise Configuration
# For organizations with multiple teams/projects

trigger:
  schedules:
  - cron: "0 6 * * 1"  # Monday 6 AM for leadership reports
    displayName: Enterprise Weekly Review
    branches:
      include:
      - main

pool:
  vmImage: 'ubuntu-latest'

parameters:
  - name: analyzeTop
    displayName: 'Items per project'
    type: number
    default: 20  # Larger analysis for enterprise view
  
  - name: projectNames
    displayName: 'Projects (comma-separated)'
    type: string
    default: 'Platform Team,Mobile App,Data Analytics,DevOps Infrastructure'
  
  - name: analysisMode
    displayName: 'Analysis Focus'
    type: string
    default: 'Business'  # Leadership focused on business value
    values:
      - 'Business'
      - 'Technical' 
      - 'Comprehensive'

variables:
  - group: 'copilot-credentials'
  
  # Enterprise configuration
  - name: ENTERPRISE_ANALYSIS
    value: true
  - name: GENERATE_CROSS_PROJECT_INSIGHTS
    value: true
  
  # Notification configuration
  - group: 'enterprise-notifications'  # Contains TEAMS_EXECUTIVE_WEBHOOK, SLACK_CHANNEL
  
  # Performance settings for multiple projects
  - name: COPILOT_TIMEOUT
    value: 120  # Extended timeout for detailed analysis
  - name: PARALLEL_PROCESSING
    value: 3    # Process 3 projects simultaneously

stages:
# Multi-project analysis
- stage: MultiProjectSetup
  displayName: 'Multi-Project Setup'
  jobs:
  - job: PrepareMultiAnalysis
    displayName: 'Setup Enterprise Analysis'
    steps:
    - script: |
        echo "üè¢ ENTERPRISE BACKLOG ANALYSIS"
        echo "=============================="
        
        # Parse project list
        IFS=',' read -ra PROJECTS <<< "${{ parameters.projectNames }}"
        
        echo "Projects to analyze:"
        for project in "${PROJECTS[@]}"; do
          echo "  - ${project// /}"
        done
        
        echo "Items per project: ${{ parameters.analyzeTop }}"
        echo "Total estimated items: $((${#PROJECTS[@]} * ${{ parameters.analyzeTop }}))"
        echo "=============================="
        
        # Create project list file for processing
        printf '%s\n' "${PROJECTS[@]}" > project-list.txt
        cp project-list.txt $(Agent.TempDirectory)/
        
      displayName: 'Parse Project Configuration'

- stage: ParallelProjectAnalysis
  displayName: 'Analyze All Projects'
  dependsOn: MultiProjectSetup
  jobs:
  # Dynamic job creation for each project
  - job: AnalyzeProjects
    displayName: 'Multi-Project Analysis'
    strategy:
      parallel: 3  # Process multiple projects in parallel
    steps:
    
    - script: |
        # Setup for multi-project processing
        curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
        sudo apt-get update && sudo apt-get install -y nodejs jq
        sudo npm install -g @github/copilot
        
        # Download project list
        cp $(Agent.TempDirectory)/project-list.txt .
        
        export GITHUB_TOKEN="$(GITHUB_TOKEN)"
        export GH_TOKEN="$(GITHUB_TOKEN)"
        
        # Process each project
        PROJECT_INDEX=$(($(System.JobPositionInPhase) - 1))
        PROJECT_NAME=$(sed -n "$((PROJECT_INDEX + 1))p" project-list.txt)
        
        if [ -n "$PROJECT_NAME" ]; then
          echo "üîÑ Processing project: $PROJECT_NAME"
          PROJECT_ENCODED=$(echo "$PROJECT_NAME" | sed 's/ /%20/g')
          
          # Create project-specific WIQL
          cat > project-query.json << EOF
          {
            "query": "SELECT [System.Id], [System.Title], [System.WorkItemType], [System.State], [Microsoft.VSTS.Common.Priority], [Microsoft.VSTS.Scheduling.StoryPoints] FROM WorkItems WHERE [System.TeamProject] = '$PROJECT_NAME' AND [System.WorkItemType] IN ('Epic', 'Feature', 'User Story') AND [System.State] NOT IN ('Closed', 'Done', 'Removed') ORDER BY [Microsoft.VSTS.Common.Priority] DESC"
          }
          EOF
          
          # Execute query
          curl -s -X POST \
               -H "Authorization: Bearer $(System.AccessToken)" \
               -H "Content-Type: application/json" \
               -d @project-query.json \
               "$(System.CollectionUri)${PROJECT_ENCODED}/_apis/wit/wiql?api-version=7.0" \
               -o project-workitems.json
          
          # Get limited set of items
          IDS=$(cat project-workitems.json | jq -r ".workItems[:${{ parameters.analyzeTop }}] | map(.id) | join(\",\")")
          
          if [ -n "$IDS" ] && [ "$IDS" != "null" ]; then
            # Fetch details
            curl -s -H "Authorization: Bearer $(System.AccessToken)" \
                 "$(System.CollectionUri)${PROJECT_ENCODED}/_apis/wit/workitems?ids=$IDS&\$expand=all&api-version=7.0" \
                 -o "project-details-${PROJECT_INDEX}.json"
            
            # Quick analysis for enterprise summary
            ITEM_COUNT=$(cat "project-details-${PROJECT_INDEX}.json" | jq '.value | length')
            
            # Enterprise-focused analysis prompt
            ENTERPRISE_PROMPT="As an executive advisor, analyze these work items from project '$PROJECT_NAME' for strategic business value. Focus on: ROI potential, strategic alignment, resource requirements, risk assessment. Provide executive summary with recommendations."
            
            echo "$ENTERPRISE_PROMPT" > enterprise-prompt.txt
            echo "Project: $PROJECT_NAME" >> enterprise-prompt.txt
            echo "Work Items: $ITEM_COUNT" >> enterprise-prompt.txt
            echo "Analysis Mode: ${{ parameters.analysisMode }}" >> enterprise-prompt.txt
            
            # Get high-level insights
            ENTERPRISE_ANALYSIS=$(cat enterprise-prompt.txt | timeout 90 copilot 2>&1)
            
            # Create project summary
            cat > "enterprise-summary-${PROJECT_INDEX}.md" << EOF
            ## üìä Project: $PROJECT_NAME
            
            **Items Analyzed:** $ITEM_COUNT  
            **Analysis Date:** $(date '+%Y-%m-%d')
            
            ### üéØ Executive Insights
            $ENTERPRISE_ANALYSIS
            
            ---
            EOF
            
            echo "‚úÖ Completed analysis for $PROJECT_NAME ($ITEM_COUNT items)"
          else
            echo "‚ö†Ô∏è No items found for project: $PROJECT_NAME"
          fi
        else
          echo "‚ÑπÔ∏è No project assigned to this parallel job"
        fi
        
      displayName: 'Process Project'
      env:
        GITHUB_TOKEN: $(GITHUB_TOKEN)
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Project Analysis'
      inputs:
        pathToPublish: 'enterprise-summary-*.md'
        artifactName: 'enterprise-project-summaries'
      condition: always()

- stage: EnterpriseReporting
  displayName: 'Enterprise Reporting'
  dependsOn: ParallelProjectAnalysis
  jobs:
  - job: ExecutiveDashboard
    displayName: 'Generate Executive Dashboard'
    steps:
    
    - task: DownloadBuildArtifacts@0
      displayName: 'Download Project Summaries'
      inputs:
        artifactName: 'enterprise-project-summaries'
        downloadPath: '$(Agent.TempDirectory)'
    
    - script: |
        echo "üìà ENTERPRISE DASHBOARD GENERATION"
        echo "================================="
        
        # Combine all project summaries
        cat > enterprise-dashboard.md << 'HEADER'
        # üè¢ Enterprise Backlog Analysis Dashboard
        
        **Generated:** $(date '+%Y-%m-%d %H:%M:%S UTC')  
        **Analysis Scope:** Multi-Project Enterprise View  
        **Pipeline Run:** $(Build.BuildId)
        
        ## üìã Executive Summary
        
        This report provides strategic insights across multiple product development teams, focusing on business value, resource allocation, and portfolio priorities.
        
        ---
        
        HEADER
        
        # Append individual project summaries
        find $(Agent.TempDirectory) -name "enterprise-summary-*.md" -exec cat {} \; >> enterprise-dashboard.md
        
        # Add enterprise-level recommendations
        cat >> enterprise-dashboard.md << 'FOOTER'
        
        ## üéØ Portfolio-Level Recommendations
        
        ### Immediate Actions (Next 30 Days)
        1. **Resource Reallocation** - Review projects with low business value scores
        2. **Risk Mitigation** - Address high-risk items across all teams  
        3. **Strategic Alignment** - Ensure all teams focus on company OKRs
        
        ### Strategic Initiatives (Next Quarter)
        1. **Cross-Team Dependencies** - Identify and resolve inter-project blockers
        2. **Capacity Planning** - Right-size teams based on backlog analysis
        3. **Innovation Investment** - Balance maintenance vs. innovation work
        
        ### Metrics to Track
        - Average quality scores by team
        - Business value distribution across projects
        - Technical debt accumulation trends
        - Resource utilization efficiency
        
        ---
        
        **üìä For detailed project analysis, see individual project artifacts**
        
        **üîÑ Next enterprise review:** $(date -d '+7 days' '+%Y-%m-%d')
        
        FOOTER
        
        echo "‚úÖ Enterprise dashboard generated"
        
        # Create executive summary metrics
        echo "üìä ENTERPRISE METRICS" > enterprise-metrics.txt
        echo "=====================" >> enterprise-metrics.txt
        echo "Analysis Date: $(date)" >> enterprise-metrics.txt
        echo "Projects Analyzed: ${{ parameters.projectNames }}" >> enterprise-metrics.txt  
        echo "Items per Project: ${{ parameters.analyzeTop }}" >> enterprise-metrics.txt
        echo "Analysis Focus: ${{ parameters.analysisMode }}" >> enterprise-metrics.txt
        echo "Pipeline ID: $(Build.BuildId)" >> enterprise-metrics.txt
        
      displayName: 'Generate Enterprise Dashboard'
    
    - script: |
        # Send executive notification (if configured)
        if [ -n "$(TEAMS_EXECUTIVE_WEBHOOK)" ]; then
          curl -X POST $(TEAMS_EXECUTIVE_WEBHOOK) \
            -H "Content-Type: application/json" \
            -d '{
              "title": "Enterprise Backlog Analysis Complete",
              "text": "Weekly portfolio analysis is ready for executive review. Check pipeline artifacts for detailed insights across all development teams.",
              "themeColor": "0078D4",
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "View Dashboard",
                "targets": [{
                  "os": "default",
                  "uri": "$(System.CollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
                }]
              }]
            }' || echo "Teams notification failed"
        fi
        
        echo "üîî Executive team notified (if webhook configured)"
        
      displayName: 'Notify Leadership'
      condition: always()
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Enterprise Dashboard'
      inputs:
        pathToPublish: 'enterprise-dashboard.md'
        artifactName: 'enterprise-dashboard'
      condition: always()
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Enterprise Metrics'
      inputs:
        pathToPublish: 'enterprise-metrics.txt'
        artifactName: 'enterprise-metrics'
      condition: always()